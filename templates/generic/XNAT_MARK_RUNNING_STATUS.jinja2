HCP_RUN_UTILS="{{ HCP_RUN_UTILS }}"
XNAT_PBS_JOBS="{{ XNAT_PBS_JOBS }}"
XNAT_PBS_JOBS_ARCHIVE_ROOT="{{ XNAT_PBS_JOBS_ARCHIVE_ROOT }}"

source ${HCP_RUN_UTILS}/shlib/log.shlib  # Logging related functions
source ${HCP_RUN_UTILS}/shlib/utils.shlib  # Utility functions
log_Msg "XNAT_PBS_JOBS: ${XNAT_PBS_JOBS}"
log_Msg "HCP_RUN_UTILS: ${HCP_RUN_UTILS}"
log_Msg "XNAT_PBS_JOBS_ARCHIVE_ROOT: ${XNAT_PBS_JOBS_ARCHIVE_ROOT}"


g_user="{{ USERNAME }}"
g_password="{{ USERNAME }}"
g_server="{{ USERNAME }}"
g_project="{{ USERNAME }}"
g_scan="{{ USERNAME }}"
g_subject="{{ USERNAME }}"
g_classifier="{{ SUBJECT_CLASSIFIER }}"
g_resource="{{ FIELDMAP }}"
g_working_dir="{{ WORKING_DIR }}"
g_running="TRUE" #or "FALSE"
{#

	--submitted		: all these mean the same thing
	--queued		:  jobs have been submitted and are either queued up or
	--running		:  running

	--not-running		: all these mean the same thing
	--not-queued		:  jobs are not queued, submitted, running
	--done			:  jobs may have completed successfully or not
#}











show_job_start

show_platform_info

get_options "$@"

{% if functional %}
local directory="${XNAT_PBS_JOBS_BUILD_DIR}/${g_project}/FunctionalPreprocessing.${g_subject}_${g_classifier}_${g_scan}_RUNNING_STATUS"
local file="FunctionalPreprocessing.${g_subject}_${g_classifier}_${g_scan}.RUNNING"
{% else %}
NAME="DiffusionPreprocessing"
NAME="MsmAllProcessing"
NAME="MultiRunIcaFixProcessing"
NAME="StructuralPreprocessing"
NAME="StructuralPreprocessingHandEdit"

local directory="${XNAT_PBS_JOBS_BUILD_DIR}/${g_project}/${NAME}.${g_subject}_${g_classifier}_RUNNING_STATUS"
local file="${NAME}.${g_subject}_${g_classifier}.RUNNING"
{% endif %}

local existing_file="${XNAT_PBS_JOBS_ARCHIVE_ROOT}/${g_project}/arc001/${g_subject}_${g_classifier}/RESOURCES/RunningStatus/${file}"
local path=${directory}/${file}

if [ "${g_running}" = "TRUE" ]; then
    mkdir -p ${directory}
    echo "User: ${g_user}, Reason: ${g_reason}" > ${path}
    ${XNAT_PBS_JOBS}/WorkingDirPut/PutDirIntoResource.sh \
                --user=${g_user} \
                --password=${g_password} \
                --server=${g_server} \
                --project=${g_project} \
                --subject=${g_subject} \
                --session=${g_subject}_${g_classifier} \
                --resource=${g_resource} \
                --mem="256" \
                --reason=${g_reason} \
                --dir=${directory} \
                --use-http \
                --protocol="https" \
                --force
        rm -rf ${directory}

else
    if [ -e "${existing_file}" ]; then
        ${XNAT_PBS_JOBS}/WorkingDirPut/RemoveFileFromResource.sh \
                    --user=${g_user} \
                    --password=${g_password} \
                    --protocol="https" \
                    --server=${g_server} \
                    --project=${g_project} \
                    --subject=${g_subject} \
                    --session=${g_subject}_${g_classifier} \
                    --resource=${g_resource} \
                    --file-path-within-resource=${file}
    fi

fi

log_Msg "Complete"
