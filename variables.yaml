#
# DEFAULT VARIABLE ASSIGNMENTS
#
DEFAULT: &default
  USER: $ENV_USER
  HOME: $ENV_HOME
  TIMESTAMP: $TIMESTAMP
  PYTHON: $AUX_DIR/virtualenv/bin/python
  XNAT_CREDENTIALS_FILE: $HOME/.xnat_credentials
  PIPELINE_REPO: $HOME/hcp-pipelines
  #PIPELINE_REPO: $HOME/hcp-pipelines-patch
  #PIPELINE_REPO: $HOME/hcp-pipelines-newpipelines
  ASSETS_DIR: $PIPELINE_REPO/assets
  PYTHON_IMPORT_DIR: $PIPELINE_REPO/lib
  EXPECTED_FILES_LIST: $ASSETS_DIR/expected_files/$PIPELINE_NAME.txt
  AUX_DIR: /ceph/intradb/chpc_resources
  BUILD_MOUNT_ROOT: /ceph/scratch/intradb/build
  BUILD_ROOT: $BUILD_MOUNT_ROOT/chpc/build/$USER
  BUILD_DIR: $BUILD_ROOT/$PIPELINE_NAME
  LOG_DIR: $BUILD_MOUNT_ROOT/chpc/logs/$USER
  GRADIENT_COEFFICIENT_PATH: $AUX_DIR/gradient_coefficient_files
  FREESURFER_LICENSE_PATH: $AUX_DIR/freesurfer/license.txt
  CONTAINERS_DIR: $AUX_DIR/containers
  QUNEX_VERSION: 0.96.2a
  QUNEX_CONTAINER: $CONTAINERS_DIR/qunex_suite-${QUNEX_VERSION}.sif
  ## OLD (0.93.2 and earlier)
  #QUNEX_CONTAINER: $CONTAINERS_DIR/qunex_${QUNEX_VERSION}.sif
  ARCHIVE_ROOT: /ceph/intradb/archive
  RESOURCES_ROOT: ${ARCHIVE_ROOT}/${PROJECT}/arc001/${SESSION}/RESOURCES
  PUT_SERVER_LIST: >-
    http://10.27.113.140:8080
    http://10.27.113.141:8080
    http://10.27.113.142:8080
    http://10.27.113.143:8080
    http://10.27.113.144:8080
    http://10.27.113.145:8080
    http://10.27.113.146:8080
    http://10.27.113.147:8080
    http://10.27.113.148:8080
    http://10.27.113.149:8080

  CLOBBER_RESOURCE: True
  WALLTIME_LIMIT_HOURS: 24
  MEM_LIMIT_GBS: 8
  USE_SCRATCH_FOR_PROCESSING: False
  RUN_COMBINED_STEPS: False
  # MRH:  Now for default, we're binding /tmp to /scratch.  We were often filling up tmp space which caused silent failures.
  SCRATCH_TMP_DIR: /scratch/$USER/singularity/tmp/${PIPELINE_NAME}.$SESSION.${TIMESTAMP}.TMPDIR
  #SCRATCH_TMP_DIR: /ceph/scratch/intradb/tmp/chpc_runs/$USER/${PIPELINE_NAME}.$SESSION.${TIMESTAMP}.TMPDIR
  AUTOLAUNCH_AT_END: True
  #AUTOLAUNCH_AT_END: False
  # Choices for BREAKPOINT: get, process, clean, put, check or run_all to run the combined script
  #BREAKPOINT: process
  #BREAKPOINT: check
  BREAKPOINT: run_all

#defaults from scripts.yaml:
  SINGULARITY_BIND_PATH: $BUILD_DIR,$ARCHIVE_ROOT
  GET_DATA_BINDPATH: $SINGULARITY_BIND_PATH
  CHECK_DATA_BINDPATH: $SINGULARITY_BIND_PATH
  MARK_RUNNING_STATUS_BINDPATH: $SINGULARITY_BIND_PATH
  PUT_DATA_BINDPATH: $SINGULARITY_BIND_PATH
  PBS_EMAIL_ADDR: ccf-chpc@humanconnectome.org
  PROCESS_PBS_HASWELL: True
  PROCESS_PBS_K20X: False
  PROCESS_PBS_GPU: 0
  PROCESS_NVIDIA: False
  PROCESS_DATA_BINDPATH: $GRADIENT_COEFFICIENT_PATH,$SINGULARITY_BIND_PATH

#common_vars:
  SCRATCH_SPACE: /scratch/$USER/buildspace/structural/$PROJECT
  BUILD_SPACE: ${BUILD_DIR}/${PROJECT}
  DIR_PREFIX: ${PIPELINE_NAME}.${SESSION}${_SCAN}.${TIMESTAMP}
  WORKING_DIR_BASENAME: ${DIR_PREFIX}.XNAT_PROCESS_DATA
  WORKING_DIR: ${BUILD_SPACE}/$WORKING_DIR_BASENAME
  CLEAN_DATA_DIR_BASENAME: ${DIR_PREFIX}.XNAT_CLEAN_DATA
  CLEAN_DATA_DIR: ${BUILD_SPACE}/$CLEAN_DATA_DIR_BASENAME
  CHECK_DATA_DIR: ${BUILD_SPACE}/${DIR_PREFIX}.XNAT_CHECK_DATA
  MARK_COMPLETION_DIR: ${BUILD_SPACE}/${DIR_PREFIX}.XNAT_MARK_COMPLETE_RUNNING_STATUS
  SCRIPTNAME: ${SESSION}${_SCAN}.${PIPELINE_NAME}
  SCRIPTNAME_GET: ${SCRIPTNAME}.XNAT_GET_DATA_job
  SCRIPTNAME_PROCESS: ${SCRIPTNAME}.PROCESS_DATA_job
  SCRIPTNAME_RUNALL: ${SCRIPTNAME}.RUNALL_DATA_job
  SCRIPTNAME_CLEAN: ${SCRIPTNAME}.CLEAN_DATA_job
  SCRIPTNAME_PUT: ${SCRIPTNAME}.XNAT_PUT_DATA_job
  SCRIPTNAME_CHECK: ${SCRIPTNAME}.XNAT_CHECK_DATA_job
  SCRIPTNAME_MARK_STATUS: ${SCRIPTNAME}.MARK_COMPLETE_RUNNING_STATUS
  STARTTIME_FILE_NAME: ProcessingInfo/${SESSION}${_SCAN}.${PIPELINE_NAME}.starttime
  PRUNNER_LOG_PATH: ${CHECK_DATA_DIR}/${SCRIPTNAME}.prunner.log

#
# STRUCTURAL PREPROCESSING 
# 

structural_preprocess:
  <<: *default
  USE_SCRATCH_FOR_PROCESSING: True
  USE_PRESCAN_NORMALIZED: False
  OUTPUT_RESOURCE_NAME: Structural_preproc
  WALLTIME_LIMIT_HOURS: 72

#
# HAND-EDITING PIPELINE
# 

hand_edit:
  <<: *default
  USE_SCRATCH_FOR_PROCESSING: True
  MEM_LIMIT_GBS: 16
  WALLTIME_LIMIT_HOURS: 72
  OUTPUT_RESOURCE_NAME: Structural_preproc_handedit
  HAND_EDIT_PROCESSING_DIR: /scratch/$USER/hand_edit_buildspace
  SINGULARITY_BIND_PATH: $BUILD_DIR,$ARCHIVE_ROOT,$HAND_EDIT_PROCESSING_DIR

#
# FUNCTIONAL PREPROCESSING 
# 

functional_preprocess:
  <<: *default
  OUTPUT_RESOURCE_NAME: ${SCAN}_preproc

# 
# DIFFUSION PREPROCESSING 
# 

diffusion_preprocess:
  <<: *default
  PROCESS_PBS_K20X: True
  # Specifically request the older V100S, since the newer GPUs require CUDA 11.1
  PROCESS_PBS_GPU: "tesla_v100S:1"
  PROCESS_NVIDIA: True
  OUTPUT_RESOURCE_NAME: Diffusion_preproc
  MEM_LIMIT_GBS: 32
  WALLTIME_LIMIT_HOURS: 24
  #WALLTIME_LIMIT_HOURS: 60

bedpostx:
  <<: *default
  PROCESS_PBS_K20X: True
  # Specifically request the older V100S, since the newer GPUs require CUDA 11.1
  PROCESS_PBS_GPU: "tesla_v100S:1"
  PROCESS_NVIDIA: True
  OUTPUT_RESOURCE_NAME: Diffusion_bedpostx
  MEM_LIMIT_GBS: 8
  WALLTIME_LIMIT_HOURS: 3
  USE_CUSTOM_BATCH: True
#
# ICA-FIX PROCESSING 
# 

multirunicafix:
  <<: *default
  MEM_LIMIT_GBS: 48
  WALLTIME_LIMIT_HOURS: 24
  #WALLTIME_LIMIT_HOURS: 60
  OUTPUT_RESOURCE_NAME: MultiRunIcaFix_proc
  USE_CUSTOM_BATCH: True

# 
# MSM-ALL PROCESSING 
# 

msmall_process:
  <<: *default
  MEM_LIMIT_GBS: 20
  WALLTIME_LIMIT_HOURS: 48
  #WALLTIME_LIMIT_HOURS: 60
  OUTPUT_RESOURCE_NAME: MsmAll_proc
  USE_CUSTOM_BATCH: True

# 
# PATCH PROCESSING 
# 

patch_run:
  <<: *default
  MEM_LIMIT_GBS: 24
  WALLTIME_LIMIT_HOURS: 24
  OUTPUT_RESOURCE_NAME: PatchFiles
  QUNEX_VERSION: 0.98.5
  #USE_CUSTOM_BATCH: False
  #PROCESS_DATA_BINDPATH: $GRADIENT_COEFFICIENT_PATH,$SINGULARITY_BIND_PATH,/$AUX_DIR/patch_runs

# 
# REAPPLY FIX PROCESSING 
# 

reapplyfix_process:
  <<: *default
  MEM_LIMIT_GBS: 48
  WALLTIME_LIMIT_HOURS: 24
  OUTPUT_RESOURCE_NAME: ReapplyFix_proc
  USE_CUSTOM_BATCH: True

# 
# TICA FIX PROCESSING 
# 

tica_process:
  <<: *default
  MEM_LIMIT_GBS: 24
  WALLTIME_LIMIT_HOURS: 4
  OUTPUT_RESOURCE_NAME: tICA_proc
  USE_CUSTOM_BATCH: True
  QUNEX_VERSION: 0.96.4a
  PROCESS_DATA_BINDPATH: $GRADIENT_COEFFICIENT_PATH,$SINGULARITY_BIND_PATH,/$AUX_DIR/tICA

#
# ASL PROCESSING
#

asl_process:
  <<: *default
  MEM_LIMIT_GBS: 16
  WALLTIME_LIMIT_HOURS: 12
  QUNEX_VERSION: 0.98.5
  #PROCESS_DATA_BINDPATH: $GRADIENT_COEFFICIENT_PATH,$SINGULARITY_BIND_PATH,/home/NRG-SVC-HCPi/qunex_repo/hcp-asl:/opt/HCP/hcp-asl
  OUTPUT_RESOURCE_NAME: ASL_proc

#
# TASK fMRI PROCESSING
#

task_process:
  <<: *default
  MEM_LIMIT_GBS: 16
  WALLTIME_LIMIT_HOURS: 12
  OUTPUT_RESOURCE_NAME: ${SCAN}_analysis_proc
  TASK_FILES: $ASSETS_DIR/TaskAnalysis/$PROJECT_ID
  USE_CUSTOM_BATCH: True

